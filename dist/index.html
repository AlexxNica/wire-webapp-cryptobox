<!DOCTYPE html>
<!-- Wire, Copyright (C) 2016 Wire Swiss GmbH -->
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Demo</title>
    <link rel="shortcut icon" href="data:image/x-icon;" type="image/x-icon" />
    <script src="lib/static/system.js/system.js"></script>
    <script src="util/system.config.js"></script>
    <script src="system/wire-webapp-cryptobox.js"></script>
  </head>
  <body>
    <script>
      var cryptobox = undefined;

      System.import('postal').then(function(postal) {
        var channelName = 'cryptobox';
        var channel = postal.channel(channelName);
        channel.subscribe('new-prekeys', function(data) {
          console.log('postal.js :: Received \'' + data.length + '\' new PreKey(s). We need to upload them...');
        });
        console.log('postal.js :: Subscribed to channel "' + channelName + '".');

        return System.import('wire-webapp-cryptobox');
      }).then(function(module) {
        cryptobox = module.default;

        var storage = new cryptobox.store.IndexedDB('demo_page');
        var box = new cryptobox.Cryptobox(storage, 10);
        return box.init();
      }).then(function(instance) {
        var fingerprint = instance.identity.public_key.fingerprint();
        var message = 'Local Identity: ' + fingerprint;
        document.write(message);
      });
    </script>
  </body>
</html>
